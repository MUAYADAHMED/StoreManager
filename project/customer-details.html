<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ - Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨ÙˆÙÙŠØ©</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#3B82F6",
            secondary: "#10B981",
          },
        },
      },
    };
  </script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap");
    body { 
      font-family: "Tajawal", sans-serif; 
    }
    .content-area { 
      padding-bottom: 100px; 
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 30;
    }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="bg-gray-50">

  <!-- HEADER -->
  <div class="bg-white shadow-sm px-4 py-3 flex items-center gap-3 sticky top-0 z-20">
    <button onclick="goBack()" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200">
      <i class="ri-arrow-right-line text-xl text-gray-700"></i>
    </button>

    <div>
      <h1 class="text-lg font-bold text-gray-800" id="customer-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
      <p class="text-xs text-gray-500">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</p>
    </div>

    <div class="ml-auto flex gap-2">
      <button onclick="exportStatement()"
        class="w-9 h-9 flex items-center justify-center rounded-full bg-white shadow hover:bg-gray-100">
        <i class="ri-download-line text-gray-600 text-base"></i>
      </button>

      <button onclick="shareStatement()"
        class="w-9 h-9 flex items-center justify-center rounded-full bg-white shadow hover:bg-gray-100">
        <i class="ri-share-line text-gray-600 text-base"></i>
      </button>
    </div>
  </div>

  <main class="container mx-auto px-4 pt-6 content-area">
    <!-- Loading indicator -->
    <div id="loading-indicator" class="text-center py-10">
      <div class="loading-spinner"></div>
      <p class="text-gray-500 mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„...</p>
    </div>

    <!-- Content (hidden initially) -->
    <div id="content-area" class="hidden">
      <!-- CUSTOMER CARD -->
      <div class="bg-white p-5 rounded-xl shadow-sm border mb-6">
        <div class="flex items-center gap-6">

          <!-- SMALLER AVATAR -->
          <div class="w-14 h-14 rounded-full bg-blue-600 flex items-center justify-center text-white text-2xl font-bold" id="customer-avatar">
            Ø­
          </div>

          <div class="flex-1">
            <h2 class="font-bold text-xl text-gray-800" id="customer-fullname">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
            <p class="text-gray-600 text-sm flex items-center gap-1" id="customer-phone">
              <i class="ri-phone-line text-gray-500"></i>
              777777777
            </p>

            <div class="mt-2 flex gap-6 text-sm">
              <p><span class="text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª:</span> <span class="font-bold" id="transaction-count">0</span></p>
              <p><span class="text-gray-500">Ø¢Ø®Ø± Ù…Ø¹Ø§Ù…Ù„Ø©:</span> <span class="font-bold" id="last-transaction">--</span></p>
            </div>
          </div>

          <!-- SMALLER BALANCE BADGE -->
          <div class="text-center">
            <p class="text-[11px] text-gray-500 leading-none mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
            <p class="text-xl font-bold" id="customer-balance">0 Ø±.Ø³</p>
          </div>
        </div>
      </div>

      <!-- STAT CARDS -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-4 rounded-xl shadow-sm border flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
            <i class="ri-file-list-line text-blue-600 text-lg"></i>
          </div>
          <div>
            <p class="text-xs text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</p>
            <p class="text-lg font-bold text-blue-600" id="total-invoices">0</p>
          </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm border flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
            <i class="ri-money-dollar-circle-line text-green-600 text-lg"></i>
          </div>
          <div>
            <p class="text-xs text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</p>
            <p class="text-lg font-bold text-green-600" id="total-payments">0 Ø±.Ø³</p>
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="bg-white rounded-xl p-4 shadow-sm border mb-6">
        <div class="flex justify-between flex-wrap gap-3">

          <div class="flex gap-2">
            <button class="px-3 py-1 bg-primary text-white rounded-full text-xs filter-btn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
            <button class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs filter-btn" data-filter="invoice">ÙÙˆØ§ØªÙŠØ±</button>
            <button class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs filter-btn" data-filter="payment">Ù…Ø¯ÙÙˆØ¹Ø§Øª</button>
          </div>

          <div class="flex gap-2">
            <button onclick="openTransactionModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm flex gap-1 items-center">
              <i class="ri-add-line"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©
            </button>

            <button onclick="printStatement()" class="bg-white border px-4 py-2 rounded-lg text-sm flex gap-1 items-center">
              <i class="ri-printer-line"></i> Ø·Ø¨Ø§Ø¹Ø©
            </button>
          </div>
        </div>
      </div>

      <!-- TRANSACTIONS LIST -->
      <h2 class="text-lg font-semibold text-gray-800 mb-3">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h2>

      <div class="space-y-4" id="transactions-list">
        <!-- Transactions will be loaded here -->
      </div>
    </div>
  </main>

  <!-- Bottom Navigation -->
  <div id="navbar"></div>

  <!-- Floating Button -->
  <div id="floatingButton"></div>

  <!-- Transaction Modal -->
  <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-end sm:items-center justify-center backdrop-blur-sm">
    <div class="bg-white w-full sm:w-[450px] h-auto rounded-t-2xl sm:rounded-2xl shadow-2xl transform transition-all">
      <div class="p-4 bg-gray-50 border-b rounded-t-2xl flex justify-between items-center">
        <h2 class="text-lg font-bold text-gray-800" id="trans-modal-title">Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <button id="trans-close-btn" class="text-gray-500 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
      </div>
      
      <div class="p-5">
        <!-- Toggle Type -->
        <div class="flex bg-gray-200 p-1 rounded-lg mb-5">
          <button id="btn-type-invoice" class="flex-1 py-2 rounded-md text-sm font-bold bg-white text-emerald-600 shadow-sm transition-all">ÙØ§ØªÙˆØ±Ø© / Ù‚ÙŠØ¯</button>
          <button id="btn-type-payment" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-500 transition-all">Ø¯ÙØ¹Ø© Ù†Ù‚Ø¯ÙŠØ©</button>
        </div>

        <!-- Invoice Section -->
        <div id="invoice-section">
          <div class="relative mb-3">
            <label class="text-xs font-bold text-gray-700 mb-1 block">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</label>
            <input type="text" id="item-search" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ø§Ø¨Ø­Ø« Ø£Ùˆ Ø§ÙƒØªØ¨..." autocomplete="off">
            <ul id="suggestions-list" class="suggestions-list hidden"></ul>
          </div>
          <div class="flex gap-3 mb-3">
            <div class="w-1/2">
              <label class="text-xs font-bold text-gray-700 mb-1 block">Ø§Ù„Ø³Ø¹Ø±</label>
              <input type="number" id="item-price" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="0.00">
            </div>
            <div class="w-1/2">
              <label class="text-xs font-bold text-gray-700 mb-1 block">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
              <input type="number" id="item-qty" value="1" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm">
            </div>
          </div>
          <button id="btn-add-item" class="w-full py-2 border-2 border-dashed border-blue-400 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-50 mb-3">+ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          
          <div class="bg-gray-50 rounded-lg border p-2 h-32 overflow-y-auto mb-3" id="added-items-list">
            <p class="text-center text-gray-400 text-xs mt-10">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©</p>
          </div>
        </div>

        <!-- Payment Section -->
        <div id="payment-section" class="hidden mb-6">
          <label class="text-xs font-bold text-gray-700 mb-1 block">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ / Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
          <div class="relative">
            <input type="number" id="direct-amount" class="w-full border border-gray-300 rounded-lg p-4 text-xl font-bold text-center text-green-600 focus:ring-2 focus:ring-green-500 focus:outline-none" placeholder="0.00">
            <span class="absolute left-4 top-5 text-gray-400 text-sm">Ø±.Ø³</span>
          </div>
          <textarea id="payment-note" class="w-full mt-3 border border-gray-300 rounded-lg p-2 text-sm" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        </div>

        <!-- Footer -->
        <div class="border-t pt-4 flex justify-between items-center">
          <div>
            <span class="text-xs text-gray-500 block">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
            <span class="text-2xl font-bold text-blue-700" id="total-display">0.00</span>
          </div>
          <button id="btn-save-transaction" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transform active:scale-95 transition">Ø­ÙØ¸</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load common JS -->
  <script src="js/common.js"></script>
  
  <!-- PDF Generation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // Global variables for transaction modal
    let currentTransactionType = "invoice";
    let currentCustomerId = null;
    let invoiceItems = [];
    let currentFilter = 'all';
    let dataLoaded = false;

    // Save data when leaving the page
    window.addEventListener('beforeunload', function() {
      if (dataLoaded) {
        saveDataToLocalStorage();
        console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©');
      }
    });

    window.addEventListener('pagehide', function() {
      if (dataLoaded) {
        saveDataToLocalStorage();
        console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© (pagehide)');
      }
    });

    // Initialize page
    document.addEventListener("DOMContentLoaded", function() {
      // Get customer ID from localStorage
      currentCustomerId = localStorage.getItem('currentCustomerId');
      
      // Load components
      loadComponent('navbar', 'components/navbar.html');
      loadComponent('floatingButton', 'components/floating-button.html');
      
      // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… Ù„ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ - Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©
      setTimeout(() => {
        setFabAction(openTransactionModal, 'fa-receipt', 'blue');
      }, 500);
      
      // Check if customer ID exists
      if (!currentCustomerId) {
        showNotification("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„", "error");
        goBack();
        return;
      }
      
      // Wait for data to load
      waitForData();
      
      // Setup filter buttons
      setupFilterButtons();
      
      // Setup transaction modal
      setupTransactionModal();
      
      // Add event listener for save transaction
      document.addEventListener('componentLoaded', function(e) {
        if (e.detail && e.detail.componentId) {
          // Components loaded
        }
      });
    });

    // Wait for data to be loaded
    function waitForData() {
      if (typeof appData !== 'undefined' && appData.customers && appData.customers.length > 0) {
        dataLoaded = true;
        loadCustomerData();
      } else {
        // If data not loaded yet, try again after a short delay
        setTimeout(waitForData, 100);
      }
    }

    // Load customer data
    function loadCustomerData() {
      // Find customer in appData
      const customer = appData.customers.find(c => c.id == currentCustomerId);
      
      if (!customer) {
        showNotification("Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "error");
        goBack();
        return;
      }
      
      // Hide loading indicator and show content
      document.getElementById('loading-indicator').classList.add('hidden');
      document.getElementById('content-area').classList.remove('hidden');
      
      // Update customer info
      document.getElementById('customer-name').textContent = customer.name;
      document.getElementById('customer-fullname').textContent = customer.name;
      document.getElementById('customer-phone').innerHTML = `<i class="ri-phone-line text-gray-500"></i> ${customer.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…'}`;
      document.getElementById('customer-avatar').textContent = customer.name.charAt(0);
      
      // Calculate balance
      const balance = calculateCustomerBalance(customer.id);
      const balanceElement = document.getElementById('customer-balance');
      balanceElement.textContent = `${Math.abs(balance).toLocaleString("ar-EG")} Ø±.Ø³`;
      balanceElement.className = balance >= 0 ? "text-xl font-bold text-green-600" : "text-xl font-bold text-red-600";
      
      // Update transaction count
      document.getElementById('transaction-count').textContent = customer.transactions.length;
      
      // Update last transaction date
      if (customer.transactions.length > 0) {
        const sortedTransactions = [...customer.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
        const lastTransaction = new Date(sortedTransactions[0].date).toLocaleDateString("ar-EG");
        document.getElementById('last-transaction').textContent = lastTransaction;
      }
      
      // Calculate statistics
      let totalInvoices = 0;
      let totalPayments = 0;
      
      customer.transactions.forEach(transaction => {
        if (transaction.type === 'invoice') {
          totalInvoices++;
        } else if (transaction.type === 'payment') {
          totalPayments += transaction.amount;
        }
      });
      
      document.getElementById('total-invoices').textContent = totalInvoices;
      document.getElementById('total-payments').textContent = `${totalPayments.toLocaleString("ar-EG")} Ø±.Ø³`;
      
      // Render transactions
      renderTransactions(customer.transactions);
    }

    // Update page when data is loaded/reloaded
    function updateCurrentPageData() {
      if (currentCustomerId) {
        loadCustomerData();
      }
    }

    // Calculate customer balance
    function calculateCustomerBalance(customerId) {
      const customer = appData.customers.find((c) => c.id == customerId);
      if (!customer) return 0;

      let balance = 0;
      customer.transactions.forEach((t) => {
        if (t.type === "invoice") balance += t.amount;
        else if (t.type === "payment") balance -= t.amount;
      });

      return balance;
    }

    // Render transactions
    function renderTransactions(transactions) {
      const container = document.getElementById('transactions-list');
      container.innerHTML = "";
      
      // Filter transactions based on current filter
      let filteredTransactions = transactions;
      if (currentFilter !== 'all') {
        filteredTransactions = transactions.filter(t => t.type === currentFilter);
      }
      
      // Sort transactions by date (newest first)
      filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (filteredTransactions.length === 0) {
        container.innerHTML = `
          <div class="bg-white border rounded-xl p-8 text-center">
            <i class="ri-inbox-line text-4xl text-gray-300 mb-2"></i>
            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
          </div>
        `;
        return;
      }
      
      // Render each transaction
      filteredTransactions.forEach(transaction => {
        const transactionElement = createTransactionElement(transaction);
        container.appendChild(transactionElement);
      });
    }

    // Create transaction element
    function createTransactionElement(transaction) {
      const div = document.createElement('div');
      
      if (transaction.type === 'invoice') {
        div.className = "bg-white border rounded-xl p-4 shadow-sm";
        
        let itemsHtml = '';
        if (transaction.items && transaction.items.length > 0) {
          itemsHtml = `
            <div class="bg-gray-50 p-3 rounded-lg mb-3 text-sm">
              <p class="font-medium">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</p>
              <ul class="list-disc pr-5 mt-1 text-gray-700">
                ${transaction.items.map(item => `<li>${item.name} Ã— ${item.quantity} â€” ${item.price} Ø±.Ø³</li>`).join('')}
              </ul>
            </div>
          `;
        }
        
        div.innerHTML = `
          <div class="flex justify-between mb-2">
            <p class="font-semibold text-gray-800">ÙØ§ØªÙˆØ±Ø© #${transaction.id}</p>
            <button onclick="shareInvoice(${transaction.id})" class="text-green-600 text-xl">
              <i class="ri-whatsapp-line"></i>
            </button>
          </div>
          <p class="text-sm text-gray-500 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(transaction.date).toLocaleDateString("ar-EG")}</p>
          ${itemsHtml}
          <p class="font-bold text-red-600">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${transaction.amount.toLocaleString("ar-EG")} Ø±.Ø³</p>
        `;
      } else if (transaction.type === 'payment') {
        div.className = "bg-green-50 border border-green-200 rounded-xl p-4 shadow-sm";
        div.innerHTML = `
          <p class="font-semibold text-green-700 mb-1">Ø¯ÙØ¹Ø© Ù…Ø³ØªÙ„Ù…Ø©</p>
          <p class="text-sm text-gray-600">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(transaction.date).toLocaleDateString("ar-EG")}</p>
          ${transaction.description ? `<p class="text-sm text-gray-600 mt-1">${transaction.description}</p>` : ''}
          <p class="text-green-700 font-bold mt-2">+${transaction.amount.toLocaleString("ar-EG")} Ø±.Ø³</p>
        `;
      }
      
      return div;
    }

    // Setup filter buttons
    function setupFilterButtons() {
      const filterButtons = document.querySelectorAll('.filter-btn');
      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Update active state
          filterButtons.forEach(btn => {
            btn.classList.remove('bg-primary', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-600');
          });
          
          this.classList.remove('bg-gray-100', 'text-gray-600');
          this.classList.add('bg-primary', 'text-white');
          
          // Update current filter
          currentFilter = this.dataset.filter;
          
          // Reload customer data to apply filter
          if (dataLoaded) {
            const customer = appData.customers.find(c => c.id == currentCustomerId);
            if (customer) {
              renderTransactions(customer.transactions);
            }
          }
        });
      });
    }

    // Setup transaction modal
    function setupTransactionModal() {
      // Toggle transaction type buttons
      document.getElementById('btn-type-invoice').addEventListener('click', () => toggleTransType('invoice'));
      document.getElementById('btn-type-payment').addEventListener('click', () => toggleTransType('payment'));
      
      // Add item button
      document.getElementById('btn-add-item').addEventListener('click', addItemToInvoice);
      
      // Save transaction button
      document.getElementById('btn-save-transaction').addEventListener('click', saveTransaction);
      
      // Close modal button
      document.getElementById('trans-close-btn').addEventListener('click', closeTransactionModal);
      
      // Direct amount input
      document.getElementById('direct-amount').addEventListener('input', updateTotal);
      
      // Setup click outside to close suggestions
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#item-search') && !e.target.closest('#suggestions-list')) {
          document.getElementById('suggestions-list').classList.add('hidden');
        }
      });
    }

    // Go back to customers page
    function goBack() {
      localStorage.removeItem('currentCustomerId');
      window.location.href = 'customers.html';
    }

    // Open transaction modal
    function openTransactionModal() {
      // Ensure customer ID is available
      if (!currentCustomerId) {
        showNotification('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„', 'error');
        return;
      }
      
      const customer = appData.customers.find(c => c.id == currentCustomerId);
      
      if (!customer) {
        showNotification('Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
      }
      
      // Reset modal state
      currentTransactionType = 'invoice';
      invoiceItems = [];
      document.getElementById('btn-type-invoice').classList.add('bg-white', 'text-emerald-600');
      document.getElementById('btn-type-invoice').classList.remove('text-gray-500');
      document.getElementById('btn-type-payment').classList.remove('bg-white', 'text-emerald-600');
      document.getElementById('btn-type-payment').classList.add('text-gray-500');
      document.getElementById('invoice-section').classList.remove('hidden');
      document.getElementById('payment-section').classList.add('hidden');
      document.getElementById('added-items-list').innerHTML = '<p class="text-center text-gray-400 text-xs mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø¶Ø§ÙØ©</p>';
      document.getElementById('total-display').textContent = '0.00';
      
      // Update modal title
      document.getElementById('trans-modal-title').textContent = `Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© - ${customer.name}`;
      
      // Show modal
      document.getElementById('transaction-modal').classList.remove('hidden');
      
      // Setup item search
      setupItemSearch();
    }

    // Toggle transaction type
    function toggleTransType(type) {
      currentTransactionType = type;
      
      if (type === 'invoice') {
        document.getElementById('btn-type-invoice').classList.add('bg-white', 'text-emerald-600');
        document.getElementById('btn-type-invoice').classList.remove('text-gray-500');
        document.getElementById('btn-type-payment').classList.remove('bg-white', 'text-emerald-600');
        document.getElementById('btn-type-payment').classList.add('text-gray-500');
        document.getElementById('invoice-section').classList.remove('hidden');
        document.getElementById('payment-section').classList.add('hidden');
      } else {
        document.getElementById('btn-type-payment').classList.add('bg-white', 'text-emerald-600');
        document.getElementById('btn-type-payment').classList.remove('text-gray-500');
        document.getElementById('btn-type-invoice').classList.remove('bg-white', 'text-emerald-600');
        document.getElementById('btn-type-invoice').classList.add('text-gray-500');
        document.getElementById('invoice-section').classList.add('hidden');
        document.getElementById('payment-section').classList.remove('hidden');
      }
      
      updateTotal();
    }

    // Setup item search
    function setupItemSearch() {
      const searchInput = document.getElementById('item-search');
      searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        const suggestionsList = document.getElementById('suggestions-list');
        
        if (query.length < 1) {
          suggestionsList.classList.add('hidden');
          return;
        }
        
        const filteredItems = appData.items.filter(item => 
          item.name.toLowerCase().includes(query)
        );
        
        if (filteredItems.length > 0) {
          suggestionsList.innerHTML = filteredItems.map(item => `
            <li onclick="selectItemFromSearch(${item.id})">${item.name} - ${item.price} Ø±.Ø³</li>
          `).join('');
          suggestionsList.classList.remove('hidden');
        } else {
          suggestionsList.classList.add('hidden');
        }
      });
    }

    // Select item from search
    function selectItemFromSearch(itemId) {
      const item = appData.items.find(i => i.id === itemId);
      if (item) {
        document.getElementById('item-search').value = item.name;
        document.getElementById('item-price').value = item.price;
        document.getElementById('suggestions-list').classList.add('hidden');
      }
    }

    // Add item to invoice
    function addItemToInvoice() {
      const itemName = document.getElementById('item-search').value;
      const itemPrice = parseFloat(document.getElementById('item-price').value) || 0;
      const itemQty = parseInt(document.getElementById('item-qty').value) || 1;
      
      if (!itemName || itemPrice <= 0 || itemQty <= 0) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'error');
        return;
      }
      
      const item = {
        id: Date.now(),
        name: itemName,
        price: itemPrice,
        quantity: itemQty,
        total: itemPrice * itemQty
      };
      
      invoiceItems.push(item);
      renderAddedItems();
      
      // Reset form
      document.getElementById('item-search').value = '';
      document.getElementById('item-price').value = '';
      document.getElementById('item-qty').value = '1';
      
      updateTotal();
    }

    // Render added items
    function renderAddedItems() {
      const container = document.getElementById('added-items-list');
      
      if (invoiceItems.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400 text-xs mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø¶Ø§ÙØ©</p>';
        return;
      }
      
      container.innerHTML = invoiceItems.map(item => `
        <div class="flex justify-between items-center p-2 bg-white rounded mb-1">
          <div>
            <div class="font-medium text-sm">${item.name}</div>
            <div class="text-xs text-gray-500">${item.price} Ã— ${item.quantity}</div>
          </div>
          <div class="flex items-center">
            <span class="font-bold ml-2">${item.total.toFixed(2)}</span>
            <button onclick="removeInvoiceItem(${item.id})" class="text-red-500 hover:text-red-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    // Remove invoice item
    function removeInvoiceItem(itemId) {
      invoiceItems = invoiceItems.filter(item => item.id !== itemId);
      renderAddedItems();
      updateTotal();
    }

    // Update total
    function updateTotal() {
      let total = 0;
      
      if (currentTransactionType === 'invoice') {
        total = invoiceItems.reduce((sum, item) => sum + item.total, 0);
      } else {
        total = parseFloat(document.getElementById('direct-amount').value) || 0;
      }
      
      document.getElementById('total-display').textContent = total.toFixed(2);
    }

    // Save transaction
    function saveTransaction() {
      // Verify customer ID
      if (!currentCustomerId) {
        showNotification('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„', 'error');
        return;
      }

      let amount = 0;
      let description = '';
      
      if (currentTransactionType === 'invoice') {
        if (invoiceItems.length === 0) {
          showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ù„Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
          return;
        }
        
        amount = invoiceItems.reduce((sum, item) => sum + item.total, 0);
        description = `ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© (${invoiceItems.length} Ø£ØµÙ†Ø§Ù)`;
      } else {
        amount = parseFloat(document.getElementById('direct-amount').value) || 0;
        
        if (amount <= 0) {
          showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error');
          return;
        }
        
        description = document.getElementById('payment-note').value || 'Ø¯ÙØ¹Ø© Ù†Ù‚Ø¯ÙŠØ©';
      }
      
      // Add transaction to the customer
      const customer = appData.customers.find(c => c.id == currentCustomerId);
      
      if (!customer) {
        showNotification('Ø®Ø·Ø£: Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
      }
      
      customer.transactions.push({
        id: Date.now(),
        type: currentTransactionType === 'invoice' ? 'invoice' : 'payment',
        amount: amount,
        date: new Date().toISOString(),
        description: description,
        items: currentTransactionType === 'invoice' ? invoiceItems : []
      });
      
      // Save data to localStorage
      saveDataToLocalStorage();
      
      // Close modal and reload data
      closeTransactionModal();
      loadCustomerData();
      showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }

    // Close transaction modal
    function closeTransactionModal() {
      document.getElementById('transaction-modal').classList.add('hidden');
      // Reset form
      invoiceItems = [];
      document.getElementById('added-items-list').innerHTML = '<p class="text-center text-gray-400 text-xs mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø¶Ø§ÙØ©</p>';
      document.getElementById('total-display').textContent = '0.00';
      document.getElementById('item-search').value = '';
      document.getElementById('item-price').value = '';
      document.getElementById('item-qty').value = '1';
      document.getElementById('direct-amount').value = '';
      document.getElementById('payment-note').value = '';
      document.getElementById('suggestions-list').classList.add('hidden');
    }

    // Share invoice
    function shareInvoice(id) {
      const customer = appData.customers.find(c => c.id == currentCustomerId);
      const msg = `ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${id} Ù„Ù„Ø¹Ù…ÙŠÙ„ ${customer.name} â€” Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨ÙˆÙÙŠØ©`;
      const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    }

    // Share statement with multiple options
    function shareStatement() {
      const customer = appData.customers.find(c => c.id == currentCustomerId);
      const balance = calculateCustomerBalance(currentCustomerId);
      
      // Create a modal for share options
      const shareOptions = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4">Ø£Ø±Ø³Ù„ Ø§Ù„ÙƒØ´Ù</h3>
            <div class="space-y-3">
              <button onclick="shareViaWhatsApp()" class="w-full flex items-center gap-3 p-4 bg-green-50 hover:bg-green-100 rounded-lg transition border border-green-200">
                <i class="fab fa-whatsapp text-green-600 text-2xl"></i>
                <div class="text-left">
                  <p class="font-bold text-gray-800">ÙˆØ§ØªØ³ Ø¢Ø¨</p>
                  <p class="text-xs text-gray-600">Ø£Ø±Ø³Ù„ Ù†Øµ Ø§Ù„ÙƒØ´Ù</p>
                </div>
              </button>
              
              <button onclick="generateAndDownloadPDF()" class="w-full flex items-center gap-3 p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition border border-blue-200">
                <i class="ri-file-pdf-line text-red-600 text-2xl"></i>
                <div class="text-left">
                  <p class="font-bold text-gray-800">ØªØ­Ù…ÙŠÙ„ PDF</p>
                  <p class="text-xs text-gray-600">Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</p>
                </div>
              </button>
              
              <button onclick="this.closest('.fixed').remove()" class="w-full p-4 bg-gray-100 hover:bg-gray-200 rounded-lg transition font-medium text-gray-800">
                Ø¥Ù„ØºØ§Ø¡
              </button>
            </div>
          </div>
        </div>
      `;
      
      const container = document.createElement('div');
      container.innerHTML = shareOptions;
      document.body.appendChild(container.firstElementChild);
    }
    
    // Share via WhatsApp
    function shareViaWhatsApp() {
      const customer = appData.customers.find(c => c.id == currentCustomerId);
      const balance = calculateCustomerBalance(currentCustomerId);
      const msg = `ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ ${customer.name}\nØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${balance.toLocaleString("ar-EG")} Ø±.Ø³\nÙ…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨ÙˆÙÙŠØ©`;
      const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
      
      // Close modal
      document.querySelector('.fixed').remove();
    }
    
    // Generate and download PDF
    function generateAndDownloadPDF() {
      const customer = appData.customers.find(c => c.id == currentCustomerId);
      const balance = calculateCustomerBalance(currentCustomerId);
      
      // Calculate statistics
      let totalInvoices = 0;
      let totalPayments = 0;
      
      customer.transactions.forEach(t => {
        if (t.type === 'invoice') totalInvoices += t.amount;
        else if (t.type === 'payment') totalPayments += t.amount;
      });
      
      const htmlContent = `
        <html dir="rtl" lang="ar">
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; margin: 0; }
              .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
              .store-name { font-size: 24px; font-weight: bold; color: #333; }
              .document-title { font-size: 14px; color: #666; margin-top: 5px; }
              .customer-info { background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
              .info-row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 12px; }
              .info-label { font-weight: bold; color: #666; }
              .info-value { color: #333; }
              .stats { display: table; width: 100%; margin-bottom: 15px; }
              .stat-row { display: table-row; }
              .stat-cell { display: table-cell; padding: 10px; border: 1px solid #ddd; background: #f9f9f9; }
              .stat-cell:first-child { text-align: right; font-weight: bold; width: 60%; }
              .stat-cell:last-child { text-align: left; font-weight: bold; color: #333; }
              .balance { text-align: center; background: #e8f5e9; padding: 15px; border-radius: 5px; margin: 15px 0; }
              .balance-label { font-size: 12px; color: #666; margin-bottom: 5px; }
              .balance-amount { font-size: 24px; font-weight: bold; color: #2e7d32; }
              .transaction-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; }
              .transaction-table th { background: #333; color: white; padding: 8px; text-align: right; border: 1px solid #ddd; }
              .transaction-table td { padding: 8px; border: 1px solid #ddd; text-align: right; }
              .transaction-table tr:nth-child(even) { background: #f9f9f9; }
              .footer { text-align: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 10px; color: #999; }
              .type-invoice { background: #fff3cd; }
              .type-payment { background: #d4edda; }
            </style>
          </head>
          <body>
            <div class="header">
              <div class="store-name">Ø¨ÙˆÙÙŠØ© Ø§Ù„Ø£ØµØ§Ù„Ø©</div>
              <div class="document-title">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            </div>
            
            <div class="customer-info">
              <div class="info-row">
                <span class="info-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
                <span class="info-value">${customer.name}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Ø§Ù„Ù‡Ø§ØªÙ:</span>
                <span class="info-value">${customer.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                <span class="info-value">${new Date().toLocaleDateString('ar-EG')}</span>
              </div>
            </div>
            
            <div class="stats">
              <div class="stat-row">
                <div class="stat-cell">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª)</div>
                <div class="stat-cell">${totalInvoices.toLocaleString('ar-EG')} Ø±.Ø³</div>
              </div>
              <div class="stat-row">
                <div class="stat-cell">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>
                <div class="stat-cell">${totalPayments.toLocaleString('ar-EG')} Ø±.Ø³</div>
              </div>
            </div>
            
            <div class="balance">
              <div class="balance-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
              <div class="balance-amount">${Math.abs(balance).toLocaleString('ar-EG')} Ø±.Ø³</div>
              <div style="font-size: 11px; margin-top: 5px; color: #666;">
                ${balance > 0 ? '(Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª)' : balance < 0 ? '(Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©)' : '(Ù…ÙˆØ§Ø²Ù†Ø© Ø§Ù„ØµÙØ±)'}
              </div>
            </div>
            
            <table class="transaction-table">
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                </tr>
              </thead>
              <tbody>
                ${customer.transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20).map(t => `
                  <tr class="${t.type === 'invoice' ? 'type-invoice' : 'type-payment'}">
                    <td>${new Date(t.date).toLocaleDateString('ar-EG')}</td>
                    <td>${t.type === 'invoice' ? 'ÙØ§ØªÙˆØ±Ø©' : 'Ø¯ÙØ¹Ø©'}</td>
                    <td>${t.description}</td>
                    <td>${t.amount.toLocaleString('ar-EG')} Ø±.Ø³</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            
            <div class="footer">
              <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨ÙˆÙÙŠØ©</p>
              <p>${new Date().toLocaleString('ar-EG')}</p>
            </div>
          </body>
        </html>
      `;
      
      const opt = {
        margin: 10,
        filename: `ÙƒØ´Ù_${customer.name}_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
      };
      
      try {
        html2pdf(htmlContent, opt);
        showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ´Ù Ø¨ØµÙŠØºØ© PDF', 'success');
      } catch(error) {
        console.error('Error generating PDF:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ PDF', 'error');
      }
    }

    // Export statement
    function exportStatement() {
      generateAndDownloadPDF();
    }

    // Print statement
    function printStatement() {
      showNotification("Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ø®Ø§ØµÙŠØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹", "info");
    }
  </script>

</body>
</html>